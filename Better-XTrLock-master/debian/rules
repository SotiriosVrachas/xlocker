#!/usr/bin/make -f
# debian/rules file for xtrlock-2.0
# Based upon the sample debian.rules file by Ian Jackson.

package=xtrlock

arch=$(shell dpkg --print-architecture)
STRIP=strip

CFLAGS=-O2 -g -DSHADOW_PWD

build:
	$(checkdir)
	xmkmf
	$(MAKE) CFLAGS="$(CFLAGS)" CDEBUGFLAGS="" xtrlock
	touch build

clean:
	$(checkdir)
	-rm -f build
	-rm -f xtrlock *.o *.bak Makefile
	-rm -rf debian/tmp *~ debian/files debian/substvars debian/*~

binary-indep:	checkroot
#No binary independent files in this package

binary-arch:	checkroot build
	-rm -rf debian/tmp
	install -m 755 -d debian/tmp/usr/bin debian/tmp/usr/share/man/man1
	install -m 755 -d debian/tmp/usr/share/doc/xtrlock debian/tmp/DEBIAN
	install -m 755 -d debian/tmp/usr/lib/menu
	# has to be setgid shadow to support shadow passwords.  --marekm
	install -m 755 xtrlock debian/tmp/usr/bin/xtrlock
	$(STRIP) debian/tmp/usr/bin/xtrlock
	install -m 644 xtrlock.man debian/tmp/usr/share/man/man1/xtrlock.1x
	gzip -9v debian/tmp/usr/share/man/man1/xtrlock.1x
	install -m 644 debian/changelog debian/tmp/usr/share/doc/xtrlock
	install -m 644 debian/README.Debian debian/tmp/usr/share/doc/xtrlock
	gzip -9v debian/tmp/usr/share/doc/xtrlock/*
	( cd debian/tmp/usr/share/doc/xtrlock && ln -s changelog.gz changelog.Debian.gz )
	install -m 644 debian/copyright debian/tmp/usr/share/doc/xtrlock
	install -m 644 debian/menu debian/tmp/usr/lib/menu/xtrlock
	install -m 755 debian/postinst debian/postrm debian/tmp/DEBIAN
	cp debian/control debian/tmp/DEBIAN/control
	dpkg-shlibdeps debian/tmp/usr/bin/xtrlock
	dpkg-gencontrol -isp
	chown -R root.root debian/tmp
	chown root.shadow debian/tmp/usr/bin/xtrlock
	chmod -R g-w debian/tmp
	chmod 2755 debian/tmp/usr/bin/xtrlock
	dpkg --build debian/tmp ..

binary:	binary-indep binary-arch

define checkdir
	test -f debian/rules
endef

checkroot:
	$(checkdir)
	test root = "`whoami`"

.PHONY: binary clean checkroot
